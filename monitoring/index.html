<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=generator content="Relearn 5.11.2"><meta name=description content><meta name=author content="Choria Project"><title>Monitoring :: Choria Stream Replicator</title><link href=https://choria-io.github.io/stream-replicator/monitoring/index.xml rel=alternate type=application/rss+xml title="Monitoring :: Choria Stream Replicator"><link href=https://choria-io.github.io/stream-replicator/css/fontawesome-all.min.css?1676560447 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/stream-replicator/css/fontawesome-all.min.css?1676560447 rel=stylesheet></noscript><link href=https://choria-io.github.io/stream-replicator/css/auto-complete.css?1676560447 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/stream-replicator/css/auto-complete.css?1676560447 rel=stylesheet></noscript><link href=https://choria-io.github.io/stream-replicator/css/perfect-scrollbar.min.css?1676560447 rel=stylesheet><link href=https://choria-io.github.io/stream-replicator/css/nucleus.css?1676560447 rel=stylesheet><link href=https://choria-io.github.io/stream-replicator/css/fonts.css?1676560447 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/stream-replicator/css/fonts.css?1676560447 rel=stylesheet></noscript><link href=https://choria-io.github.io/stream-replicator/css/theme.css?1676560447 rel=stylesheet><link href=https://choria-io.github.io/stream-replicator/css/theme-choria-relearn.css?1676560447 rel=stylesheet id=variant-style><link href=https://choria-io.github.io/stream-replicator/css/ie.css?1676560447 rel=stylesheet><link href=https://choria-io.github.io/stream-replicator/css/variant.css?1676560447 rel=stylesheet><link href=https://choria-io.github.io/stream-replicator/css/print.css?1676560447 rel=stylesheet media=print><script src=https://choria-io.github.io/stream-replicator/js/url.js?1676560447></script>
<script src=https://choria-io.github.io/stream-replicator/js/variant.js?1676560447></script>
<script>window.index_json_url="https://choria-io.github.io/stream-replicator/index.json";var root_url="https://choria-io.github.io/stream-replicator/",baseUriFull,baseUri=root_url.replace(/\/$/,'');window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://choria-io.github.io/stream-replicator/",window.variants&&variants.init(["choria-relearn"])</script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=https://choria-io.github.io/stream-replicator/monitoring/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div class=navigation><span class="nav nav-next topbar-link"><i class="fa fa-chevron-right fa-fw"></i></span></div><div class=navigation><a class="nav nav-prev topbar-link" href=https://choria-io.github.io/stream-replicator/configuration/choria_registration/index.html title="Choria Registration Data (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title="Menu (CTRL+ALT+n)"><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title="Table of Contents (CTRL+ALT+t)"><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/stream-replicator/index.html><span itemprop=name>Choria Stream Replicator</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Monitoring</span><meta itemprop=position content="2"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper dir=ltr><nav id=TableOfContents><ul><li><a href=#message-source-information>Message Source Information</a></li><li><a href=#sampling-advisories>Sampling Advisories</a><ul><li><a href=#advisory-schema>Advisory Schema</a></li><li><a href=#advisory-details>Advisory Details</a></li></ul></li><li><a href=#inspecting-run-time-data>Inspecting Run-time Data</a><ul><li><a href=#searching-advisories>Searching Advisories</a></li><li><a href=#viewing-the-state>Viewing the state</a></li><li><a href=#viewing-cluster-sync-gossip>Viewing cluster sync gossip</a></li></ul></li><li><a href=#prometheus-data>Prometheus Data</a></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=monitoring>Monitoring</h1><h2 id=message-source-information>Message Source Information</h2><p>Every message that gets copied has a header added called <code>Choria-SR-Source</code> with an example being <code>CHORIA_REGISTRATION 10631 US-EAST-1 PARTITION1 1673433286805</code>.
Using this you can determine where any copied message is from, which worker copied it and the delay between the message creation, and it&rsquo;s arriving in the target.</p><p>From this we know the following:</p><ul><li>The source stream is called <code>CHORIA_REGISTRATION</code></li><li>The message we are looking at has a Stream Sequence of <code>10631</code> in the source stream</li><li>The replicator name (configured using top level <code>name</code> in the config file) is <code>US-EAST-1</code></li><li>The <code>name</code> set on the <code>stream</code> configuration is <code>PARTITION1</code> this allows you to tell which specific copier config copied it, helping to identify ordering or partition logic issues</li><li>The message was stored in the source at <code>1673433286805</code> which is a milliseconds since Unix epoch. Delta between this and the message creation time in the target is how long copy took</li></ul><h2 id=sampling-advisories>Sampling Advisories</h2><p>Advisories are created for sampled streams as described in <a href=../configuration/sampling>Copying Samples of Data</a>. Read on for full detail about those advisories.</p><p>Advisories are published to the NATS Server hosting the Source Stream. These advisories could be stored in a Stream and that Stream can also be replicated elsewhere - allowing a large shared real time view of an entire multi location fleet to be build.</p><p>When Advisories are published to a Stream one can configure them to be Reliable meaning each message will be tried 10 times on a Backoff policy. Still does not ensure they are 100% reliable but does make them weather short outages.</p><p>Advisories should therefor not be the only way you use to calculate expiring nodes but to augment another system giving it an insight it could not otherwise have if it was build using Sampled data.</p><h3 id=advisory-schema>Advisory Schema</h3><p>Every advisory message has a <code>protocol</code> key with the value <code>io.choria.sr.v2.age_advisory</code>. This indicates the schema for this message is <a href=https://choria.io/schemas/sr/v2/age_advisory.json target=_blank>https://choria.io/schemas/sr/v2/age_advisory.json</a>.</p><h3 id=advisory-details>Advisory Details</h3><p>Each advisory looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.sr.v2.age_advisory&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;event_id&#34;</span>: <span style=color:#e6db74>&#34;26QSY17sb9aJL6UPPG6MLOVjIrE&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;inspect_field&#34;</span>: <span style=color:#e6db74>&#34;sender&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;age&#34;</span>: <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;seen&#34;</span>: <span style=color:#ae81ff>1647351430</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;replicator&#34;</span>: <span style=color:#e6db74>&#34;US-EAST&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#ae81ff>1647355030</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;event&#34;</span>: <span style=color:#e6db74>&#34;timeout&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some.host.example.net&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>protocol</code></td><td>Constant indicating the schema</td></tr><tr><td><code>event_id</code></td><td>A unique correlation ID per event, k-sortable</td></tr><tr><td><code>inspect_field</code></td><td>The key being inspected in the data that caused the advisory</td></tr><tr><td><code>age</code></td><td>The time since this sender last checked in, seconds</td></tr><tr><td><code>seen</code></td><td>Unix time in UTC this sender was last seen</td></tr><tr><td><code>replicator</code></td><td>A unique indicator of the stream replicator where this advisory originated from. <code>name</code> in the main config section</td></tr><tr><td><code>timestamp</code></td><td>The time this advisory was generated. Unix timestamp in UTC</td></tr><tr><td><code>event</code></td><td>The type of advisory. <code>new</code>, <code>timeout</code>, <code>recover</code> or <code>expire</code></td></tr><tr><td><code>value</code></td><td>The value found in the sent data that identifies the unique sender</td></tr></tbody></table><h2 id=inspecting-run-time-data>Inspecting Run-time Data</h2><p>The <code>stream-replicator</code> command comes with a number of tools to inspect the state and behavior of the system. Most of these
will only make sense when deployed clustered or when data sampling is enabled.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>Some of these commands connect to NATS. You need a configuration context that can be created using <code>nats context</code>, this command accept <code>--context</code> or will use the selected context.</p><p>To connect to Choria Brokers in Organization Issuer mode pass <code>--choria-jwt</code> and <code>--choria-seed</code> with your Choria tokens.</p></div></div><h3 id=searching-advisories>Searching Advisories</h3><p>When sampling the Replicator will publish advisories about node states. If you store these in a stream by ingesting <code>choria.registration.advisories.></code>
you can search for a specific or just view all data:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ stream-replicator admin advisories REGISTRATION_ADVISORIES node1.example.net --since 5h
Searching 17185 messages for advisories related to node1.example.net

[2023-01-11 12:41:37]     new node1.example.net seen 0s earlier on US_EAST_1
[2023-01-11 12:52:39] timeout node1.example.net seen 11m2s earlier on US_EAST_1
[2023-01-11 12:52:40]  expire node1.example.net seen 11m3s earlier on US_EAST_1
</code></pre><h3 id=viewing-the-state>Viewing the state</h3><p>The above advisories are built by tracking unique values seen in messages, you can view the state store:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ sudo stream-replicator admin state /var/lib/stream-replicator node1.example.net
/var/lib/stream-replicator/CHORIA_REGISTRATION_US_EAST_1_4.json:

           Value: node1.example.net
       Seen Time: 2023-01-11 12:47:31.714555561 +0000 UTC (18s)
     Copied Time: 2023-01-11 12:47:31.721943055 +0000 UTC (18s)
    Payload Size: 13916
         Advised: false
</code></pre><h3 id=viewing-cluster-sync-gossip>Viewing cluster sync gossip</h3><p>When deploying the replicator in a cluster it will sync the state shown above using a gossip protocol, you can observe
this in real time:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ stream-replicator admin gossip
[CHORIA_REGISTRATION.US_EAST_1_4] size: 22272 advised: false: copied: 34m59.985s xx.example.net
[CHORIA_REGISTRATION.US_EAST_1_3] size: 6567 advised: false: copied: 19m59.986s xx.example.net
[CHORIA_REGISTRATION.US_EAST_1_2] size: 6668 advised: false: copied: 29m59.994s xx.example.net
[CHORIA_REGISTRATION.US_EAST_1_2] size: 6748 advised: false: copied: 24m59.992s xx.example.net
[CHORIA_REGISTRATION.US_EAST_1_3] size: 7119 advised: false: copied: 49m59.998s xx.example.net
[CHORIA_REGISTRATION.US_EAST_1_3] size: 6748 advised: false: copied: 24m59.993s xx.example.net
[CHORIA_REGISTRATION.US_EAST_1_3] size: 6785 advised: false: copied: 29m59.989s xx.example.net
</code></pre><h2 id=prometheus-data>Prometheus Data</h2><p>We have extensive Prometheus Metrics about the operation of the system allowing you to track message counts, size and efficiency of the Sampling feature.</p><table><thead><tr><th>Statistic</th><th>Descriptions</th></tr></thead><tbody><tr><td><code>choria_stream_replicator_tracker_total_items</code></td><td>Number of entries being tracked for sampling purposes</td></tr><tr><td><code>choria_stream_replicator_tracker_seen_by_gossip</code></td><td>Number of entries that we learned about via gossip synchronization</td></tr><tr><td><code>choria_stream_replicator_advisor_publish_errors</code></td><td>The number of times publishing advisories failed</td></tr><tr><td><code>choria_stream_replicator_advisor_publish_total_messages</code></td><td>The total number of advisories sent</td></tr><tr><td><code>choria_stream_replicator_limiter_messages_without_limit_field_count</code></td><td>The number of messages that did not have the data field or header used for limiting/sampling</td></tr><tr><td><code>choria_stream_replicator_replicator_total_messages</code></td><td>The total number of messages processed including ones that would be ignored</td></tr><tr><td><code>choria_stream_replicator_replicator_total_bytess</code></td><td>The size of messages processed including ones that would be ignored</td></tr><tr><td><code>choria_stream_replicator_replicator_handler_error_count</code></td><td>The number of times the handler failed to process a message</td></tr><tr><td><code>choria_stream_replicator_replicator_processing_time_seconds</code></td><td>How long it took to process messages</td></tr><tr><td><code>choria_stream_replicator_replicator_stream_sequence</code></td><td>The stream sequence of the last message received from the consumer</td></tr><tr><td><code>choria_stream_replicator_replicator_too_old_messages</code></td><td>How many messages were discarded for being too old</td></tr><tr><td><code>choria_stream_replicator_replicator_copied_messages</code></td><td>How many messages were copied</td></tr><tr><td><code>choria_stream_replicator_replicator_copied_bytes</code></td><td>The size of messages that were copied</td></tr><tr><td><code>choria_stream_replicator_replicator_skipped_messages</code></td><td>How many messages were skipped due to limiter configuration</td></tr><tr><td><code>choria_stream_replicator_replicator_skipped_bytes</code></td><td>The size of messages that were skipped due to limited configuration</td></tr><tr><td><code>choria_stream_replicator_replicator_meta_parse_failed_count</code></td><td>How many times a message metadata could not be parsed</td></tr><tr><td><code>choria_stream_replicator_replicator_ack_failed_count</code></td><td>How many times an ack or nack failed</td></tr><tr><td><code>choria_stream_replicator_replicator_consumer_recreated</code></td><td>How many times the source consumer had to be recreated</td></tr><tr><td><code>choria_stream_replicator_election_campaigns</code></td><td>The number of campaigns a specific candidate voted in</td></tr><tr><td><code>choria_stream_replicator_election_leader</code></td><td>Indicates if a specific instance is the current leader</td></tr><tr><td><code>choria_stream_replicator_election_interval_seconds</code></td><td>The number of seconds between campaigns</td></tr></tbody></table><p>We have a <a href=https://grafana.com/grafana/dashboards/15928 target=_blank>published Grafana dashboard</a> that you can install in your site, a screenshot of the dashboard is below.</p><p><a href=#image-1f480b961961eb38866eed654828a61e class=lightbox-link><img src=https://choria-io.github.io/stream-replicator/dashboard.png alt="Dashboard 15928" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1f480b961961eb38866eed654828a61e><img src=https://choria-io.github.io/stream-replicator/dashboard.png alt="Dashboard 15928" class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation dir=ltr><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://choria-io.github.io/stream-replicator/logo.png></div><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script>var contentLangs=[]</script><script src=https://choria-io.github.io/stream-replicator/js/auto-complete.js?1676560447 defer></script>
<script src=https://choria-io.github.io/stream-replicator/js/lunr/lunr.min.js?1676560447 defer></script>
<script src=https://choria-io.github.io/stream-replicator/js/lunr/lunr.stemmer.support.min.js?1676560447 defer></script>
<script src=https://choria-io.github.io/stream-replicator/js/lunr/lunr.multi.min.js?1676560447 defer></script>
<script src=https://choria-io.github.io/stream-replicator/js/search.js?1676560447 defer></script></div><div id=content-wrapper class=highlightable><ul class=topics><li data-nav-id=/installation/index.html class=dd-item><a href=https://choria-io.github.io/stream-replicator/installation/index.html><b>1. </b>Installation</a></li><li data-nav-id=/configuration/index.html class="dd-item alwaysopen"><a href=https://choria-io.github.io/stream-replicator/configuration/index.html><b>2. </b>Configuration</a><ul id=subsections-632bb56b075027697eb90eb7e3d29a12><li data-nav-id=/configuration/basic/index.html class=dd-item><a href=https://choria-io.github.io/stream-replicator/configuration/basic/index.html><b>2.1. </b>Basic Configuration</a></li><li data-nav-id=/configuration/all/index.html class=dd-item><a href=https://choria-io.github.io/stream-replicator/configuration/all/index.html><b>2.2. </b>Copying All Data</a></li><li data-nav-id=/configuration/sampling/index.html class=dd-item><a href=https://choria-io.github.io/stream-replicator/configuration/sampling/index.html><b>2.3. </b>Copying Samples of Data</a></li><li data-nav-id=/configuration/clustering/index.html class=dd-item><a href=https://choria-io.github.io/stream-replicator/configuration/clustering/index.html><b>2.4. </b>HA Clustering</a></li><li data-nav-id=/configuration/choria_registration/index.html class=dd-item><a href=https://choria-io.github.io/stream-replicator/configuration/choria_registration/index.html><b>2.5. </b>Choria Registration Data</a></li></ul></li><li data-nav-id=/monitoring/index.html class="dd-item active"><a href=https://choria-io.github.io/stream-replicator/monitoring/index.html><b>4. </b>Monitoring</a></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://github.com/choria-io/stream-replicator><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a class=padding href=https://github.com/choria-io/stream-replicator/releases><i class="far fa-save"></i> Download</a></li><li><a class=padding href=https://github.com/choria-io/general/discussions><i class="far fa-comments"></i> Discussions</a></li><li><a class=padding href=https://github.com/choria-io/stream-replicator/issues><i class="far fa-life-ring"></i> Issues</a></li><li><a class=padding href=https://slack.puppet.com/><i class="fab fa-slack"></i> #choria</a></li></ul></div><div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=choria-relearn value=choria-relearn selected>Choria Relearn</option></select></div><div class=select-clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><button class=padding onclick=clearHistory()><i class="fas fa-history fa-fw"></i> Clear History</button></li></ul></div><div id=footer class="footerFooter showFooter"><style>#footer{font-size:13px;height:100px;margin-left:auto;margin-right:auto;padding:2rem 1rem;text-align:center;min-width:230px;max-width:300px}#footer p{margin:0}</style><p>Hosted at <a href=https://github.com/choria-io>GitHub</a> by <a href=https://www.devco.net/>R.I. Pienaar</a></p></div></div></aside><script src=https://choria-io.github.io/stream-replicator/js/clipboard.min.js?1676560447 defer></script>
<script src=https://choria-io.github.io/stream-replicator/js/perfect-scrollbar.min.js?1676560447 defer></script>
<script src=https://choria-io.github.io/stream-replicator/js/theme.js?1676560447 defer></script></body></html>